I"”³<ul id="markdown-toc">
  <li><a href="#ç‰ˆæœ¬142" id="markdown-toc-ç‰ˆæœ¬142">ç‰ˆæœ¬1.4.2</a></li>
  <li><a href="#aspectsh" id="markdown-toc-aspectsh">Aspects.h</a></li>
  <li><a href="#aspectsm" id="markdown-toc-aspectsm">Aspects.m</a></li>
</ul>
<hr />

<h1 id="ç‰ˆæœ¬142">ç‰ˆæœ¬1.4.2</h1>

<h1 id="aspectsh">Aspects.h</h1>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//</span>
<span class="c1">//  Aspects.h</span>
<span class="c1">//  Aspects - A delightful, simple library for aspect oriented programming.</span>
<span class="c1">//</span>
<span class="c1">//  Copyright (c) 2014 Peter Steinberger. Licensed under the MIT license.</span>
<span class="c1">//</span>

<span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="c1">// è¿™é‡Œè¡¨ç¤ºäº† block æ‰§è¡Œçš„æ—¶æœºï¼Œä¹Ÿå°±æ˜¯é¢å¤–æ“ä½œçš„æ‰§è¡Œæ—¶æœºï¼Œåœ¨æˆ‘çš„åº”ç”¨åœºæ™¯ä¸­å°±æ˜¯æ‰“ç‚¹é€»è¾‘çš„æ‰§è¡Œæ—¶æœºï¼Œå®ƒå¯ä»¥åœ¨åŸå§‹å‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œä¹Ÿå¯ä»¥æ˜¯æ‰§è¡Œä¹‹åï¼Œç”šè‡³å¯ä»¥å®Œå…¨æ›¿æ¢æ‰åŸæ¥çš„é€»è¾‘</span>
<span class="k">typedef</span> <span class="nf">NS_OPTIONS</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">,</span> <span class="n">AspectOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AspectPositionAfter</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1">/// Called after the original implementation (default)</span>
    <span class="n">AspectPositionInstead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>            <span class="c1">/// Will replace the original implementation.</span>
    <span class="n">AspectPositionBefore</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>            <span class="c1">/// Called before the original implementation.</span>
    
    <span class="n">AspectOptionAutomaticRemoval</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="c1">/// Will remove the hook after the first execution.</span>
<span class="p">};</span>

<span class="c1">/// Opaque Aspect Token that allows to deregister the hook.</span>
<span class="k">@protocol</span> <span class="nc">AspectToken</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>

<span class="cm">/*
 AspectToken åè®®æ—¨åœ¨è®©ä½¿ç”¨è€…å¯ä»¥çµæ´»çš„æ³¨é”€ä¹‹å‰æ·»åŠ è¿‡çš„ Hookï¼Œå†…éƒ¨è§„å®šéµå®ˆæ­¤åè®®çš„å¯¹è±¡é¡»å®ç° remove æ–¹æ³•ã€‚
 */</span>

<span class="c1">/// Deregisters an aspect.</span>
<span class="c1">/// @return YES if deregistration is successful, otherwise NO.</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">remove</span><span class="p">;</span>

<span class="k">@end</span>

<span class="c1">/// The AspectInfo protocol is the first parameter of our block syntax.</span>
<span class="k">@protocol</span> <span class="nc">AspectInfo</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span> <span class="c1">/// å½“å‰è¢«hookçš„å®ä¾‹</span>


<span class="cm">/*
 AspectInfo åè®®æ—¨åœ¨è§„èŒƒå¯¹ä¸€ä¸ªåˆ‡é¢ï¼Œå³ aspect çš„ Hook å†…éƒ¨ä¿¡æ¯çš„çº°æ¼ï¼Œæˆ‘ä»¬åœ¨ Hook æ—¶æ·»åŠ åˆ‡é¢çš„ Block ç¬¬ä¸€ä¸ªå‚æ•°å°±éµå®ˆæ­¤åè®®ã€‚
 */</span>

<span class="c1">/// The instance that is currently hooked.</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">instance</span><span class="p">;</span>

<span class="c1">/// The original invocation of the hooked method.</span>
<span class="c1">/// è¢«Hookæ–¹æ³•çš„åŸå§‹ invovation</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="n">originalInvocation</span><span class="p">;</span>

<span class="c1">/// All method arguments, boxed. This is lazily evaluated.</span>
<span class="c1">/// æ‰€æœ‰æ–¹æ³•å‚æ•°ï¼ˆè£…ç®±ä¹‹åï¼‰çš„æ‡’æƒ°æ‰§è¡Œ</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">arguments</span><span class="p">;</span>

<span class="c1">// è£…ç®±æ˜¯ä¸€ä¸ªå¼€é”€æ˜‚è´µæ“ä½œï¼Œæ‰€ä»¥ç”¨åˆ°å†å»æ‰§è¡Œã€‚</span>

<span class="k">@end</span>

<span class="cm">/**
 Aspects uses Objective-C message forwarding to hook into messages. This will create some overhead. Don't add aspects to methods that are called a lot. Aspects is meant for view/controller code that is not called a 1000 times per second.

 Adding aspects returns an opaque token which can be used to deregister again. All calls are thread safe.
 */</span>
<span class="k">@interface</span> <span class="nc">NSObject</span> <span class="p">(</span><span class="nl">Aspects</span><span class="p">)</span>

<span class="c1">/// Adds a block of code before/instead/after the current `selector` for a specific class.</span>
<span class="c1">///</span>
<span class="c1">/// @param block Aspects replicates the type signature of the method being hooked.</span>
<span class="c1">/// The first parameter will be `id&lt;AspectInfo&gt;`, followed by all parameters of the method.</span>
<span class="c1">/// These parameters are optional and will be filled to match the block signature.</span>
<span class="c1">/// You can even use an empty block, or one that simple gets `id&lt;AspectInfo&gt;`.</span>
<span class="c1">///</span>
<span class="c1">/// @note Hooking static methods is not supported.</span>
<span class="c1">/// @return A token which allows to later deregister the aspect.</span>
<span class="k">+</span> <span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">AspectToken</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">aspect_hookSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">selector</span>
                           <span class="nf">withOptions</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span>
                            <span class="nf">usingBlock</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">block</span>
                                 <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span><span class="p">;</span>

<span class="c1">/// Adds a block of code before/instead/after the current `selector` for a specific instance.</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">AspectToken</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">aspect_hookSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">selector</span>
                           <span class="nf">withOptions</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span>
                            <span class="nf">usingBlock</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">block</span>
                                 <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span><span class="p">;</span>

<span class="k">@end</span>

<span class="c1">// AspectErrorCodeæšä¸¾</span>
<span class="k">typedef</span> <span class="nf">NS_ENUM</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">,</span> <span class="n">AspectErrorCode</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AspectErrorSelectorBlacklisted</span><span class="p">,</span>                   <span class="c1">/// Selectors like release, retain, autorelease are blacklisted.</span>
    <span class="n">AspectErrorDoesNotRespondToSelector</span><span class="p">,</span>              <span class="c1">/// Selector could not be found.</span>
    <span class="n">AspectErrorSelectorDeallocPosition</span><span class="p">,</span>               <span class="c1">/// When hooking dealloc, only AspectPositionBefore is allowed.</span>
    <span class="n">AspectErrorSelectorAlreadyHookedInClassHierarchy</span><span class="p">,</span> <span class="c1">/// Statically hooking the same method in subclasses is not allowed.</span>
    <span class="n">AspectErrorFailedToAllocateClassPair</span><span class="p">,</span>             <span class="c1">/// The runtime failed creating a class pair.</span>
    <span class="n">AspectErrorMissingBlockSignature</span><span class="p">,</span>                 <span class="c1">/// The block misses compile time signature info and can't be called.</span>
    <span class="n">AspectErrorIncompatibleBlockSignature</span><span class="p">,</span>            <span class="c1">/// The block signature does not match the method or is too large.</span>

    <span class="n">AspectErrorRemoveObjectAlreadyDeallocated</span> <span class="o">=</span> <span class="mi">100</span>   <span class="c1">/// (for removing) The object hooked is already deallocated.</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">AspectErrorDomain</span><span class="p">;</span>

</code></pre></div></div>

<h1 id="aspectsm">Aspects.m</h1>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//</span>
<span class="c1">//  Aspects.m</span>
<span class="c1">//  Aspects - A delightful, simple library for aspect oriented programming.</span>
<span class="c1">//</span>
<span class="c1">//  Copyright (c) 2014 Peter Steinberger. Licensed under the MIT license.</span>
<span class="c1">//</span>

<span class="cp">#import "Aspects.h"
#import &lt;libkern/OSAtomic.h&gt;
#import &lt;objc/runtime.h&gt;
#import &lt;objc/message.h&gt;
</span>
<span class="cp">#define AspectLog(...)
</span><span class="c1">//#define AspectLog(...) do { NSLog(__VA_ARGS__); }while(0)</span>
<span class="cp">#define AspectLogError(...) do { NSLog(__VA_ARGS__); }while(0)
</span>
<span class="c1">// Block internals.</span>
<span class="k">typedef</span> <span class="nf">NS_OPTIONS</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">AspectBlockFlags</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">AspectBlockFlagsHasCopyDisposeHelpers</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">),</span>
	<span class="n">AspectBlockFlagsHasSignature</span>          <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span>
<span class="p">};</span>

<span class="c1">// ç»“æ„ä½“</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_AspectBlock</span> <span class="p">{</span>
	<span class="n">__unused</span> <span class="n">Class</span> <span class="n">isa</span><span class="p">;</span>
	<span class="n">AspectBlockFlags</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__unused</span> <span class="kt">int</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="n">__unused</span> <span class="o">*</span><span class="n">invoke</span><span class="p">)(</span><span class="k">struct</span> <span class="n">_AspectBlock</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="p">...);</span>
	<span class="k">struct</span> <span class="p">{</span>
        <span class="c1">// 1</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">reserved</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
        
        <span class="c1">// 2</span>
		<span class="c1">// requires AspectBlockFlagsHasCopyDisposeHelpers</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">copy</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dispose</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
        
        <span class="c1">// 3</span>
		<span class="c1">// requires AspectBlockFlagsHasSignature</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">signature</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">layout</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">descriptor</span><span class="p">;</span>
	<span class="c1">// imported variables</span>
<span class="p">}</span> <span class="o">*</span><span class="n">AspectBlockRef</span><span class="p">;</span>

<span class="c1">// class AspectInfo éµå¾ªäº†AspectInfoåè®®</span>
<span class="c1">// ä¸€ä¸ª Aspect æ‰§è¡Œç¯å¢ƒï¼Œä¸»è¦æ˜¯ NSInvocation ä¿¡æ¯ã€‚</span>
<span class="k">@interface</span> <span class="nc">AspectInfo</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">AspectInfo</span><span class="o">&gt;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithInstance</span><span class="p">:(</span><span class="n">__unsafe_unretained</span> <span class="n">id</span><span class="p">)</span><span class="nv">instance</span> <span class="nf">invocation</span><span class="p">:(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">unsafe_unretained</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">id</span> <span class="n">instance</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">arguments</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSInvocation</span> <span class="o">*</span><span class="n">originalInvocation</span><span class="p">;</span>
<span class="k">@end</span>

<span class="c1">// Tracks a single aspect.</span>
<span class="c1">// ä¸€ä¸ª Aspect çš„å…·ä½“å†…å®¹ã€‚è¿™é‡Œä¸»è¦åŒ…å«äº†å•ä¸ªçš„ aspect çš„å…·ä½“ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰§è¡Œæ—¶æœºï¼Œè¦æ‰§è¡Œ block æ‰€éœ€è¦ç”¨åˆ°çš„å…·ä½“ä¿¡æ¯ï¼šåŒ…æ‹¬æ–¹æ³•ç­¾åã€å‚æ•°ç­‰ç­‰</span>
<span class="c1">// AspectIdentifier å®é™…ä¸Šæ˜¯æ·»åŠ åˆ‡é¢çš„ Block çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå…¶åº”è¯¥éµå¾ª AspectToken åè®®ï¼Œäº‹å®ä¸Šä¹Ÿçš„ç¡®å¦‚æ­¤ï¼Œå…¶æä¾›äº† remove æ–¹æ³•çš„å®ç°ã€‚</span>
<span class="c1">// æ³¨æ„å¹¶ä¸æ˜¯ï¼Œè¿™é‡Œæ˜¯æœ€å¼€å§‹çœ‹çš„æ—¶å€™æé”™äº†ã€‚</span>
<span class="cm">/*
 æˆ‘æƒ³ä½œè€…åº”è¯¥æ˜¯å¿˜è®°éµå®ˆåè®®äº†. å®ç°é‡Œé¢ä¹Ÿç¡®å®æœ‰removeæ–¹æ³•
 */</span>

<span class="c1">// å®é™…ä¸Šæ˜¯è¿™æ ·çš„</span>
<span class="cm">/*
 + (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector
 withOptions:(AspectOptions)options
 usingBlock:(id)block
 error:(NSError **)error {
 return aspect_add((id)self, selector, options, block, error);
 
 è¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ªéµå®ˆäº†åè®®çš„idå¯¹è±¡ã€‚è€Œå®ç°é‡Œé¢è¿”å›çš„æ˜¯ æ˜¯ä¸€ä¸ª AspectIdentifier å¯¹è±¡ã€‚æ‰€ä»¥å¹¶ä¸æ˜¯ä½œè€…å¿˜è®°éµå®ˆåè®®äº†ã€‚è€Œæ˜¯è¿™é‡Œè¿”å›çš„æ—¶å€™åŠ äº†ã€‚ç­‰å¤–é¢æ‹¿åˆ°çš„æ—¶å€™å°±æ˜¯ä¸€ä¸ªéµå®ˆäº†åè®®çš„idå¯¹è±¡äº†ã€‚
 */</span>
<span class="k">@interface</span> <span class="nc">AspectIdentifier</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">identifierWithSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">selector</span> <span class="nf">object</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">object</span> <span class="nf">options</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span> <span class="nf">block</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">block</span> <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">invokeWithInfo</span><span class="p">:(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">AspectInfo</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">info</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">id</span> <span class="n">block</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSMethodSignature</span> <span class="o">*</span><span class="n">blockSignature</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="n">id</span> <span class="n">object</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">AspectOptions</span> <span class="n">options</span><span class="p">;</span>
<span class="k">@end</span>

<span class="c1">// Tracks all aspects for an object/class.</span>
<span class="c1">// ä¸€ä¸ªå¯¹è±¡æˆ–è€…ç±»çš„æ‰€æœ‰çš„ Aspects æ•´ä½“æƒ…å†µã€‚æ˜¯åˆ‡é¢çš„å®¹å™¨ç±»ã€‚å…³è”æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•ï¼Œå†…éƒ¨æœ‰3ä¸ªåˆ‡é¢é˜Ÿåˆ—ï¼Œåˆ†åˆ«å®¹çº³å…³è”æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•ä¸­ç›¸å¯¹åº”çš„ option çš„hoook</span>
<span class="k">@interface</span> <span class="nc">AspectsContainer</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addAspect</span><span class="p">:(</span><span class="n">AspectIdentifier</span> <span class="o">*</span><span class="p">)</span><span class="nv">aspect</span> <span class="nf">withOptions</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">injectPosition</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">removeAspect</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">aspect</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">hasAspects</span><span class="p">;</span>

<span class="c1">// ä»¥ä¸‹æ˜¯ä¸‰ä¸ªé˜Ÿåˆ—</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">beforeAspects</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">insteadAspects</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">afterAspects</span><span class="p">;</span>
<span class="k">@end</span>

<span class="c1">// åˆ‡é¢è¿½è¸ªå™¨</span>
<span class="k">@interface</span> <span class="nc">AspectTracker</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithTrackedClass</span><span class="p">:(</span><span class="n">Class</span><span class="p">)</span><span class="nv">trackedClass</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">Class</span> <span class="n">trackedClass</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">trackedClassName</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">selectorNames</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addSubclassTracker</span><span class="p">:(</span><span class="n">AspectTracker</span> <span class="o">*</span><span class="p">)</span><span class="nv">subclassTracker</span> <span class="nf">hookingSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeSubclassTracker</span><span class="p">:(</span><span class="n">AspectTracker</span> <span class="o">*</span><span class="p">)</span><span class="nv">subclassTracker</span> <span class="nf">hookingSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">subclassHasHookedSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="p">)</span><span class="nf">subclassTrackersHookingSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">NSInvocation</span> <span class="p">(</span><span class="nl">Aspects</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">aspects_arguments</span><span class="p">;</span>
<span class="k">@end</span>

<span class="c1">// è½¬æ¢æˆäºŒè¿›åˆ¶æ˜¯ã€‚0000 0111</span>
<span class="cp">#define AspectPositionFilter 0x07
</span>
<span class="cp">#define AspectError(errorCode, errorDescription) do { \
AspectLogError(@"Aspects: %@", errorDescription); \
if (error) { *error = [NSError errorWithDomain:AspectErrorDomain code:errorCode userInfo:@{NSLocalizedDescriptionKey: errorDescription}]; }}while(0)
</span>
<span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">AspectErrorDomain</span> <span class="o">=</span> <span class="s">@"AspectErrorDomain"</span><span class="p">;</span>
<span class="c1">//å›ºå®šåç¼€</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">AspectsSubclassSuffix</span> <span class="o">=</span> <span class="s">@"_Aspects_"</span><span class="p">;</span>
<span class="c1">// å›ºå®šå‰ç¼€</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">AspectsMessagePrefix</span> <span class="o">=</span> <span class="s">@"aspects_"</span><span class="p">;</span>

<span class="k">@implementation</span> <span class="nc">NSObject</span> <span class="p">(</span><span class="nl">Aspects</span><span class="p">)</span>

<span class="c1">// Aspects ä½¿ç”¨ NSObject + Categroy çš„æ–¹å¼æä¾›æ¥å£ï¼Œéå¸¸å·§å¦™çš„æ¶µç›–äº† Instance å’Œ Classã€‚</span>
<span class="c1">// Aspects æä¾›çš„æ¥å£ä¿æŒé«˜åº¦ä¸€è‡´</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Public Aspects API
</span>
<span class="k">+</span> <span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">AspectToken</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">aspect_hookSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">selector</span>
                      <span class="nf">withOptions</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span>
                       <span class="nf">usingBlock</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">block</span>
                            <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">aspect_add</span><span class="p">((</span><span class="n">id</span><span class="p">)</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// @return A token which allows to later deregister the aspect.</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">AspectToken</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">aspect_hookSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">selector</span>
                      <span class="nf">withOptions</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span>
                       <span class="nf">usingBlock</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">block</span>
                            <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">aspect_add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Private Helper
</span>
<span class="c1">// ç§æœ‰ helper</span>

<span class="c1">// aspect_add</span>
<span class="k">static</span> <span class="n">id</span> <span class="nf">aspect_add</span><span class="p">(</span><span class="n">id</span> <span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">,</span> <span class="n">AspectOptions</span> <span class="n">options</span><span class="p">,</span> <span class="n">id</span> <span class="n">block</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ–­è¨€</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

    <span class="n">__block</span> <span class="n">AspectIdentifier</span> <span class="o">*</span><span class="n">identifier</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">aspect_performLocked</span><span class="p">(</span><span class="o">^</span><span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aspect_isSelectorAllowedAndTrack</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// åˆ¤æ–­èƒ½å¦è¢«hook</span>
            <span class="c1">// è®°å½•æ•°æ®ç»“æ„</span>
            <span class="n">AspectsContainer</span> <span class="o">*</span><span class="n">aspectContainer</span> <span class="o">=</span> <span class="n">aspect_getContainerForObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
            <span class="c1">// åˆå§‹åŒ– identifier</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="p">[</span><span class="n">AspectIdentifier</span> <span class="nf">identifierWithSelector</span><span class="p">:</span><span class="n">selector</span> <span class="nf">object</span><span class="p">:</span><span class="n">self</span> <span class="n">options</span><span class="o">:</span><span class="n">options</span> <span class="n">block</span><span class="o">:</span><span class="n">block</span> <span class="n">error</span><span class="o">:</span><span class="n">error</span><span class="p">];</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">identifier</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// å¦‚æœidentifierå­˜åœ¨</span>
                <span class="c1">// åŠ åˆ°listä¸­</span>
                <span class="p">[</span><span class="n">aspectContainer</span> <span class="nf">addAspect</span><span class="p">:</span><span class="n">identifier</span> <span class="nf">withOptions</span><span class="p">:</span><span class="n">options</span><span class="p">];</span>

                
                <span class="c1">// ï¼ï¼ï¼ æƒ³æ¥è¿™é‡Œæ˜¯æ ¸å¿ƒã€‚ä¹‹å‰çš„éƒ½æ˜¯åœ¨å‡†å¤‡å’Œåˆå§‹åŒ–</span>
                <span class="c1">// Modify the class to allow message interception.</span>
                <span class="c1">// swizzling</span>
                <span class="c1">// ä¿®æ”¹classå…è®¸æ¶ˆæ¯æ‹¦æˆª</span>
                <span class="c1">// swizzling</span>
                <span class="n">aspect_prepareClassAndHookSelector</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">identifier</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// aspect_remove</span>
<span class="k">static</span> <span class="n">BOOL</span> <span class="nf">aspect_remove</span><span class="p">(</span><span class="n">AspectIdentifier</span> <span class="o">*</span><span class="n">aspect</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCAssert</span><span class="p">([</span><span class="n">aspect</span> <span class="nf">isKindOfClass</span><span class="p">:</span><span class="n">AspectIdentifier</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="s">@"Must have correct type."</span><span class="p">);</span>

    <span class="n">__block</span> <span class="n">BOOL</span> <span class="n">success</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="c1">// é”</span>
    <span class="n">aspect_performLocked</span><span class="p">(</span><span class="o">^</span><span class="p">{</span>
        <span class="c1">// æŒæœ‰</span>
        <span class="n">id</span> <span class="n">self</span> <span class="o">=</span> <span class="n">aspect</span><span class="p">.</span><span class="n">object</span><span class="p">;</span> <span class="c1">// strongify</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">AspectsContainer</span> <span class="o">*</span><span class="n">aspectContainer</span> <span class="o">=</span> <span class="n">aspect_getContainerForObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">aspect</span><span class="p">.</span><span class="n">selector</span><span class="p">);</span>
            <span class="c1">// ç§»é™¤</span>
            <span class="n">success</span> <span class="o">=</span> <span class="p">[</span><span class="n">aspectContainer</span> <span class="nf">removeAspect</span><span class="p">:</span><span class="n">aspect</span><span class="p">];</span>

            <span class="n">aspect_cleanupHookedClassAndSelector</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">aspect</span><span class="p">.</span><span class="n">selector</span><span class="p">);</span>
            <span class="c1">// destroy token</span>
            <span class="c1">// é”€æ¯</span>
            <span class="n">aspect</span><span class="p">.</span><span class="n">object</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
            <span class="n">aspect</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
            <span class="n">aspect</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="n">NSString</span> <span class="o">*</span><span class="n">errrorDesc</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"Unable to deregister hook. Object already deallocated: %@"</span><span class="p">,</span> <span class="n">aspect</span><span class="p">];</span>
            <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorRemoveObjectAlreadyDeallocated</span><span class="p">,</span> <span class="n">errrorDesc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// åŠ é”</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_performLocked</span><span class="p">(</span><span class="n">dispatch_block_t</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*
     å°†ä»£ç å—ä½œä¸ºå‚æ•°ï¼Œç„¶åå¯¹å…¶æ‰§è¡Œå‰ååŠ é”ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šå¦‚æœä»¥åè¦æ¢é”çš„ç±»å‹ï¼Œé‚£ä¹ˆåªè¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ”¹å˜å°±å¯ä»¥äº†
     */</span>
    <span class="k">static</span> <span class="n">OSSpinLock</span> <span class="n">aspect_lock</span> <span class="o">=</span> <span class="n">OS_SPINLOCK_INIT</span><span class="p">;</span>
    <span class="n">OSSpinLockLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aspect_lock</span><span class="p">);</span>
    <span class="n">block</span><span class="p">();</span>
    <span class="n">OSSpinLockUnlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aspect_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// è¿™ä¸ªæ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªselectorï¼Œè¿”å›ä¸€ä¸ªåŠ äº†å‰ç¼€çš„selector</span>
<span class="k">static</span> <span class="n">SEL</span> <span class="nf">aspect_aliasForSelector</span><span class="p">(</span><span class="n">SEL</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NSSelectorFromString</span><span class="p">([</span><span class="n">AspectsMessagePrefix</span> <span class="nf">stringByAppendingFormat</span><span class="p">:</span><span class="s">@"_%@"</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">)]);</span>
<span class="p">}</span>

<span class="c1">// æ–¹æ³•ç­¾å</span>
<span class="k">static</span> <span class="n">NSMethodSignature</span> <span class="o">*</span><span class="nf">aspect_blockMethodSignature</span><span class="p">(</span><span class="n">id</span> <span class="n">block</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// é¦–å…ˆæŠŠblockæ¡¥æ¥æˆç»“æ„ä½“</span>
    <span class="n">AspectBlockRef</span> <span class="n">layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">__bridge</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">;</span>
    
    <span class="c1">// åˆ¤æ–­ layout-&gt;flags æ˜¯å¦å­˜åœ¨</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AspectBlockFlagsHasSignature</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœä¸å­˜åœ¨ã€‚</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"The block %@ doesn't contain a type signature."</span><span class="p">,</span> <span class="n">block</span><span class="p">];</span>
        <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorMissingBlockSignature</span><span class="p">,</span> <span class="n">description</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// è·å–blockçš„descriptor,descriptorç»“æ„ä½“çš„copyæˆ–è€…signatureå­˜åœ¨ç€æ–¹æ³•ç­¾å.ä½†æ˜¯ç”±äºå…¨å±€blockå’Œå †blockå­˜åœ¨çš„ä½ç½®ä¸åŒ,æ‰€ä»¥éœ€è¦åˆ¤æ–­.å¦‚æœæ˜¯å…¨å±€block,åˆ™æ–¹æ³•ç­¾åå­˜åœ¨äºsignatureä¸Š,å¦‚æœæ˜¯å †block,åˆ™å­˜åœ¨äºcopyä¸Š.</span>
    <span class="c1">// https://www.jianshu.com/p/1849068b7833</span>
    <span class="c1">// https://blog.csdn.net/yangbodong22011/article/details/53224856</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">layout</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">;</span>
    
    <span class="c1">// é»˜è®¤ç§»åŠ¨ä¸¤æ­¥ descæŒ‡å‘ copy</span>
	<span class="n">desc</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">);</span>
    <span class="c1">// åˆ¤æ–­layout-&gt;flagsæ˜¯å¦æ˜¯AspectBlockFlagsHasCopyDisposeHelpers</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">layout</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AspectBlockFlagsHasCopyDisposeHelpers</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœæ˜¯ å†ç§»åŠ¨ä¸¤æ­¥ descæŒ‡å‘ signature</span>
		<span class="n">desc</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
    <span class="p">}</span>
    
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœä¸å­˜åœ¨descï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"The block %@ doesn't has a type signature."</span><span class="p">,</span> <span class="n">block</span><span class="p">];</span>
        <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorMissingBlockSignature</span><span class="p">,</span> <span class="n">description</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// è½¬æ¢æˆ char * signature</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">desc</span><span class="p">);</span>
    <span class="c1">// è¿”å›ç­¾å</span>
	<span class="k">return</span> <span class="p">[</span><span class="n">NSMethodSignature</span> <span class="nf">signatureWithObjCTypes</span><span class="p">:</span><span class="n">signature</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// æ˜¯å¦å…¼å®¹ç­¾å</span>
<span class="k">static</span> <span class="n">BOOL</span> <span class="nf">aspect_isCompatibleBlockSignature</span><span class="p">(</span><span class="n">NSMethodSignature</span> <span class="o">*</span><span class="n">blockSignature</span><span class="p">,</span> <span class="n">id</span> <span class="n">object</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ–­è¨€</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">blockSignature</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="c1">// å£°æ˜ç­¾ååŒ¹é…ä¸ºyes</span>
    <span class="n">BOOL</span> <span class="n">signaturesMatch</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="c1">// objçš„æ–¹æ³•ç­¾å</span>
    <span class="n">NSMethodSignature</span> <span class="o">*</span><span class="n">methodSignature</span> <span class="o">=</span> <span class="p">[[</span><span class="n">object</span> <span class="nf">class</span><span class="p">]</span> <span class="nf">instanceMethodSignatureForSelector</span><span class="p">:</span><span class="n">selector</span><span class="p">];</span>
    <span class="c1">// æ¯”è¾ƒnumberOfArguments</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">blockSignature</span><span class="p">.</span><span class="n">numberOfArguments</span> <span class="o">&gt;</span> <span class="n">methodSignature</span><span class="p">.</span><span class="n">numberOfArguments</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">signaturesMatch</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">blockSignature</span><span class="p">.</span><span class="n">numberOfArguments</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// æ•°é‡å¤§äº1æ—¶ï¼Œæ‹¿åˆ°ç¬¬ã€‚1 ä¸ª charã€‚  æ¯”è¾ƒchar çš„é¦–å­—æ¯æ˜¯ä¸æ˜¯@ï¼Œä¸æ˜¯åˆ™signaturesMatch = NO;</span>
            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">blockType</span> <span class="o">=</span> <span class="p">[</span><span class="n">blockSignature</span> <span class="nf">getArgumentTypeAtIndex</span><span class="p">:</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">blockType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'@'</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">signaturesMatch</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// Argument 0 æ˜¯ self/block ã€‚Argument 1 æ˜¯ SEL æˆ–è€… id&lt;AspectInfo&gt;ã€‚æˆ‘ä»¬ä»ä½ç½®2å¼€å§‹æ¯”è¾ƒ</span>
        <span class="c1">// Blockçš„argumentså¯ä»¥æ¯”methodæ›´å°‘ã€‚æ‰€ä»¥ä»¥ä¸‹ä»£ç æ²¡é—®é¢˜</span>
        <span class="c1">// Argument 0 is self/block, argument 1 is SEL or id&lt;AspectInfo&gt;. We start comparing at argument 2.</span>
        <span class="c1">// The block can have less arguments than the method, that's ok.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">signaturesMatch</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">NSUInteger</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">blockSignature</span><span class="p">.</span><span class="n">numberOfArguments</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">methodType</span> <span class="o">=</span> <span class="p">[</span><span class="n">methodSignature</span> <span class="nf">getArgumentTypeAtIndex</span><span class="p">:</span><span class="n">idx</span><span class="p">];</span>
                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">blockType</span> <span class="o">=</span> <span class="p">[</span><span class="n">blockSignature</span> <span class="nf">getArgumentTypeAtIndex</span><span class="p">:</span><span class="n">idx</span><span class="p">];</span>
                <span class="c1">// Only compare parameter, not the optional type data.</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">methodType</span> <span class="o">||</span> <span class="o">!</span><span class="n">blockType</span> <span class="o">||</span> <span class="n">methodType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">blockType</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                    <span class="n">signaturesMatch</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signaturesMatch</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœ signaturesMatch å˜ä¸ºNOï¼Œé‚£ä¹ˆæŠ›å‡ºé”™è¯¯</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"Block signature %@ doesn't match %@."</span><span class="p">,</span> <span class="n">blockSignature</span><span class="p">,</span> <span class="n">methodSignature</span><span class="p">];</span>
        <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorIncompatibleBlockSignature</span><span class="p">,</span> <span class="n">description</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// return  YES</span>
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Class + Selector Preparation
</span>
<span class="c1">// åˆ¤æ–­æ˜¯ä¸æ˜¯MsgForwardIMP</span>
<span class="k">static</span> <span class="n">BOOL</span> <span class="nf">aspect_isMsgForwardIMP</span><span class="p">(</span><span class="n">IMP</span> <span class="n">impl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">impl</span> <span class="o">==</span> <span class="n">_objc_msgForward</span>
<span class="cp">#if !defined(__arm64__)
</span>    <span class="o">||</span> <span class="n">impl</span> <span class="o">==</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">_objc_msgForward_stret</span>
<span class="cp">#endif
</span>    <span class="p">;</span>
<span class="p">}</span>

<span class="c1">// è·å–æ¶ˆæ¯è½¬å‘IMP</span>
<span class="k">static</span> <span class="n">IMP</span> <span class="nf">aspect_getMsgForwardIMP</span><span class="p">(</span><span class="n">NSObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">IMP</span> <span class="n">msgForwardIMP</span> <span class="o">=</span> <span class="n">_objc_msgForward</span><span class="p">;</span>
<span class="cp">#if !defined(__arm64__)
</span>    <span class="c1">// As an ugly internal runtime implementation detail in the 32bit runtime, we need to determine of the method we hook returns a struct or anything larger than id.</span>
    <span class="c1">// https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/LowLevelABI/000-Introduction/introduction.html</span>
    <span class="c1">// https://github.com/ReactiveCocoa/ReactiveCocoa/issues/783</span>
    <span class="c1">// http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042e/IHI0042E_aapcs.pdf (Section 5.4)</span>
    <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">method</span><span class="p">);</span>
    <span class="n">BOOL</span> <span class="n">methodReturnsStructValue</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">_C_STRUCT_B</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">methodReturnsStructValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">@try</span> <span class="p">{</span>
            <span class="n">NSUInteger</span> <span class="n">valueSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">NSGetSizeAndAlignment</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valueSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">valueSize</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">valueSize</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">valueSize</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">valueSize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">methodReturnsStructValue</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">@catch</span> <span class="p">(</span><span class="n">__unused</span> <span class="n">NSException</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">methodReturnsStructValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">msgForwardIMP</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">_objc_msgForward_stret</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span>    <span class="k">return</span> <span class="n">msgForwardIMP</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// å‡†å¤‡class and hook selector</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_prepareClassAndHookSelector</span><span class="p">(</span><span class="n">NSObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="n">Class</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">aspect_hookClass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span> <span class="c1">//1  swizzling forwardInvocation</span>
    <span class="c1">// è·å–Method</span>
    <span class="n">Method</span> <span class="n">targetMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
    <span class="c1">// è·å–IMP</span>
    <span class="n">IMP</span> <span class="n">targetMethodIMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">);</span>
    <span class="c1">// åˆ¤æ–­æ˜¯ä¸æ˜¯æ¶ˆæ¯è½¬å‘IMP</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aspect_isMsgForwardIMP</span><span class="p">(</span><span class="n">targetMethodIMP</span><span class="p">))</span> <span class="p">{</span> <span class="c1">//2  swizzling method</span>
        <span class="c1">// æ··å†™method. å¼„ä¸€ä¸ªè¿™ä¸ªå·²ç»å­˜åœ¨çš„æ–¹æ³•çš„åˆ«åã€‚å¹¶ä¸æ˜¯çœŸçš„copyäº†ä¸€ä»½</span>
        <span class="c1">// Make a method alias for the existing method implementation, it not already copied.</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">typeEncoding</span> <span class="o">=</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">);</span>
        <span class="c1">// æ‹¿åˆ°selectorçš„åˆ«å</span>
        <span class="n">SEL</span> <span class="n">aliasSelector</span> <span class="o">=</span> <span class="n">aspect_aliasForSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">klass</span> <span class="nf">instancesRespondToSelector</span><span class="p">:</span><span class="n">aliasSelector</span><span class="p">])</span> <span class="p">{</span>
            <span class="c1">// å¦‚æœä¸å“åº”ï¼ŒæŠ›å‡ºé”™è¯¯</span>
            <span class="n">__unused</span> <span class="n">BOOL</span> <span class="n">addedAlias</span> <span class="o">=</span> <span class="n">class_addMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">aliasSelector</span><span class="p">,</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">),</span> <span class="n">typeEncoding</span><span class="p">);</span>
            <span class="n">NSCAssert</span><span class="p">(</span><span class="n">addedAlias</span><span class="p">,</span> <span class="s">@"Original implementation for %@ is already copied to %@ on %@"</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">),</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">aliasSelector</span><span class="p">),</span> <span class="n">klass</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// We use forwardInvocation to hook in.</span>
        <span class="c1">// ä½¿ç”¨forwardInvocation hook in</span>
        <span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">aspect_getMsgForwardIMP</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">),</span> <span class="n">typeEncoding</span><span class="p">);</span>
        <span class="n">AspectLog</span><span class="p">(</span><span class="s">@"Aspects: Installed hook for -[%@ %@]."</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Will undo the runtime changes made.</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_cleanupHookedClassAndSelector</span><span class="p">(</span><span class="n">NSObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>

	<span class="n">Class</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="n">BOOL</span> <span class="n">isMetaClass</span> <span class="o">=</span> <span class="n">class_isMetaClass</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isMetaClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">klass</span> <span class="o">=</span> <span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="n">self</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Check if the method is marked as forwarded and undo that.</span>
    <span class="n">Method</span> <span class="n">targetMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
    <span class="n">IMP</span> <span class="n">targetMethodIMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aspect_isMsgForwardIMP</span><span class="p">(</span><span class="n">targetMethodIMP</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Restore the original method implementation.</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">typeEncoding</span> <span class="o">=</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">);</span>
        <span class="n">SEL</span> <span class="n">aliasSelector</span> <span class="o">=</span> <span class="n">aspect_aliasForSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
        <span class="n">Method</span> <span class="n">originalMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">aliasSelector</span><span class="p">);</span>
        <span class="n">IMP</span> <span class="n">originalIMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">);</span>
        <span class="n">NSCAssert</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">,</span> <span class="s">@"Original implementation for %@ not found %@ on %@"</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">),</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">aliasSelector</span><span class="p">),</span> <span class="n">klass</span><span class="p">);</span>

        <span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">originalIMP</span><span class="p">,</span> <span class="n">typeEncoding</span><span class="p">);</span>
        <span class="n">AspectLog</span><span class="p">(</span><span class="s">@"Aspects: Removed hook for -[%@ %@]."</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// Deregister global tracked selector</span>
    <span class="n">aspect_deregisterTrackedSelector</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>

    <span class="c1">// Get the aspect container and check if there are any hooks remaining. Clean up if there are not.</span>
    <span class="n">AspectsContainer</span> <span class="o">*</span><span class="n">container</span> <span class="o">=</span> <span class="n">aspect_getContainerForObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">container</span><span class="p">.</span><span class="n">hasAspects</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Destroy the container</span>
        <span class="n">aspect_destroyContainerForObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>

        <span class="c1">// Figure out how the class was modified to undo the changes.</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">className</span> <span class="o">=</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">className</span> <span class="nf">hasSuffix</span><span class="p">:</span><span class="n">AspectsSubclassSuffix</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">Class</span> <span class="n">originalClass</span> <span class="o">=</span> <span class="n">NSClassFromString</span><span class="p">([</span><span class="n">className</span> <span class="nf">stringByReplacingOccurrencesOfString</span><span class="p">:</span><span class="n">AspectsSubclassSuffix</span> <span class="nf">withString</span><span class="p">:</span><span class="s">@""</span><span class="p">]);</span>
            <span class="n">NSCAssert</span><span class="p">(</span><span class="n">originalClass</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@"Original class must exist"</span><span class="p">);</span>
            <span class="n">object_setClass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">originalClass</span><span class="p">);</span>
            <span class="n">AspectLog</span><span class="p">(</span><span class="s">@"Aspects: %@ has been restored."</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">originalClass</span><span class="p">));</span>

            <span class="c1">// We can only dispose the class pair if we can ensure that no instances exist using our subclass.</span>
            <span class="c1">// Since we don't globally track this, we can't ensure this - but there's also not much overhead in keeping it around.</span>
            <span class="c1">//objc_disposeClassPair(object.class);</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Class is most likely swizzled in place. Undo that.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isMetaClass</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">aspect_undoSwizzleClassInPlace</span><span class="p">((</span><span class="n">Class</span><span class="p">)</span><span class="n">self</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">class</span> <span class="o">!=</span> <span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
            	<span class="n">aspect_undoSwizzleClassInPlace</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Hook Class
</span><span class="c1">// æ ¸å¿ƒä»£ç </span>

<span class="c1">// hook class</span>
<span class="k">static</span> <span class="n">Class</span> <span class="nf">aspect_hookClass</span><span class="p">(</span><span class="n">NSObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ–­è¨€</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="c1">// å½“selfæ˜¯å®ä¾‹å¯¹è±¡çš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯ç±»å¯¹è±¡ï¼Œå¦åˆ™åˆ™è¿”å›è‡ªèº«ã€‚</span>
	<span class="n">Class</span> <span class="n">statedClass</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">class</span><span class="p">;</span>
    <span class="c1">// selfçš„isa</span>
	<span class="n">Class</span> <span class="n">baseClass</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="c1">// className</span>
	<span class="n">NSString</span> <span class="o">*</span><span class="n">className</span> <span class="o">=</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">baseClass</span><span class="p">);</span>

    <span class="c1">// Already subclassed</span>
    <span class="c1">// å·²ç»å­ç±»åŒ–è¿‡äº†</span>
	<span class="k">if</span> <span class="p">([</span><span class="n">className</span> <span class="nf">hasSuffix</span><span class="p">:</span><span class="n">AspectsSubclassSuffix</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">baseClass</span><span class="p">;</span>
        
        <span class="c1">// We swizzle a class object, not a single object.</span>
        <span class="c1">// æˆ‘ä»¬æ··å†™äº†ä¸€ä¸ªç±»å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„object</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">class_isMetaClass</span><span class="p">(</span><span class="n">baseClass</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// baseClassæ˜¯å…ƒç±»ï¼Œåˆ™selfæ˜¯class æˆ– metaClassï¼Œæ··å†™self</span>
        <span class="k">return</span> <span class="n">aspect_swizzleClassInPlace</span><span class="p">((</span><span class="n">Class</span><span class="p">)</span><span class="n">self</span><span class="p">);</span>
        <span class="c1">// å¯èƒ½æ˜¯ä¸€ä¸ª KVO çš„ç±»ï¼Œæ··å†™å°±ä½ã€‚ä¹Ÿè¦æ··å†™meta classes</span>
        <span class="c1">// Probably a KVO'ed class. Swizzle in place. Also swizzle meta classes in place.</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">statedClass</span> <span class="o">!=</span> <span class="n">baseClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å½“ä¸åŒæ—¶æ··å†™baseClass</span>
        <span class="k">return</span> <span class="n">aspect_swizzleClassInPlace</span><span class="p">(</span><span class="n">baseClass</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Default case. Create dynamic subclass.</span>
    <span class="c1">// é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åˆ›å»ºå­ç±»</span>
    <span class="c1">// æ‹¼æ¥å­ç±»åç¼€</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subclassName</span> <span class="o">=</span> <span class="p">[</span><span class="n">className</span> <span class="nf">stringByAppendingString</span><span class="p">:</span><span class="n">AspectsSubclassSuffix</span><span class="p">].</span><span class="n">UTF8String</span><span class="p">;</span>
    <span class="c1">// å°è¯•ç”¨æ‹¼æ¥åç¼€çš„åç§°è·å–isa</span>
	<span class="n">Class</span> <span class="n">subclass</span> <span class="o">=</span> <span class="n">objc_getClass</span><span class="p">(</span><span class="n">subclassName</span><span class="p">);</span>

    <span class="c1">// å¦‚æœæ‰¾ä¸åˆ°isaï¼Œä»£è¡¨è¿˜æ²¡æœ‰åŠ¨æ€åˆ›å»ºè¿‡è¿™ä¸ªå­ç±»</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subclass</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// åˆ›å»ºä¸€ä¸ª class pairã€‚ baseClass ä½œä¸ºæ–°ç±»çš„ superClassï¼Œç±»åä¸ºsubclassNameï¼Œ</span>
		<span class="n">subclass</span> <span class="o">=</span> <span class="n">objc_allocateClassPair</span><span class="p">(</span><span class="n">baseClass</span><span class="p">,</span> <span class="n">subclassName</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subclass</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// è¿”å›nilï¼Œè¡¨ç¤ºåˆ›å»ºå¤±è´¥</span>
            <span class="n">NSString</span> <span class="o">*</span><span class="n">errrorDesc</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"objc_allocateClassPair failed to allocate class %s."</span><span class="p">,</span> <span class="n">subclassName</span><span class="p">];</span>
            <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorFailedToAllocateClassPair</span><span class="p">,</span> <span class="n">errrorDesc</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// æ··å†™ ForwardInvocation</span>
		<span class="n">aspect_swizzleForwardInvocation</span><span class="p">(</span><span class="n">subclass</span><span class="p">);</span>
        <span class="c1">// subClass.class = statedClass</span>
        <span class="n">aspect_hookedGetClass</span><span class="p">(</span><span class="n">subclass</span><span class="p">,</span> <span class="n">statedClass</span><span class="p">);</span>
        <span class="c1">// subClass.isa.class = statedClass</span>
		<span class="n">aspect_hookedGetClass</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">subclass</span><span class="p">),</span> <span class="n">statedClass</span><span class="p">);</span>
        
        <span class="c1">// æ³¨å†Œæ–°ç±»</span>
		<span class="n">objc_registerClassPair</span><span class="p">(</span><span class="n">subclass</span><span class="p">);</span>
	<span class="p">}</span>

     <span class="c1">// è¦†ç›– isa</span>
	<span class="n">object_setClass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">subclass</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">subclass</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">AspectsForwardInvocationSelectorName</span> <span class="o">=</span> <span class="s">@"__aspects_forwardInvocation:"</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_swizzleForwardInvocation</span><span class="p">(</span><span class="n">Class</span> <span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ–­è¨€ klass</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="p">[</span><span class="n">NSObject</span> <span class="nf">forwardInvocation</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="c1">// If there is no method, replace will act like class_addMethod.</span>
    <span class="c1">// å¦‚æœæ²¡æœ‰methodï¼Œé‚£ä¹ˆæ›¿æ¢çš„ä½œç”¨å’Œclass_addMethodç›¸åŒ</span>
    <span class="c1">// è¿™é‡Œæ˜¯æŠŠforwardInvocation çš„ IMP æ›¿æ¢æˆ __ASPECTS_ARE_BEING_CALLED__</span>
    <span class="c1">// å¦‚æœæ˜¯replaceè¿”å›åŸforwardInvocation:çš„IMPçš„åœ°å€</span>
    <span class="c1">// ä¹‹åç³»ç»Ÿè°ƒç”¨ forwardInvocation æ—¶ã€‚å°±ä¼š</span>
    <span class="n">IMP</span> <span class="n">originalImplementation</span> <span class="o">=</span> <span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">forwardInvocation</span><span class="o">:</span><span class="p">),</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">__ASPECTS_ARE_BEING_CALLED__</span><span class="p">,</span> <span class="s">"v@:@"</span><span class="p">);</span>
    <span class="c1">// æ‹¿åˆ° originalImplementation è¯æ˜æ˜¯ replace è€Œä¸æ˜¯ addï¼Œæƒ…å†µå°‘è§</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">originalImplementation</span><span class="p">)</span> <span class="p">{</span>
<span class="err">Â Â Â Â Â Â Â Â </span><span class="c1">//Â æ·»åŠ Â AspectsForwardInvocationSelectorNameÂ çš„æ–¹æ³•ï¼ŒIMPÂ ä¸ºåŸç”ŸÂ forwardInvocation:</span>
        <span class="n">class_addMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">AspectsForwardInvocationSelectorName</span><span class="p">),</span> <span class="n">originalImplementation</span><span class="p">,</span> <span class="s">"v@:@"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">AspectLog</span><span class="p">(</span><span class="s">@"Aspects: %@ is now aspect aware."</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">klass</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_undoSwizzleForwardInvocation</span><span class="p">(</span><span class="n">Class</span> <span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="c1">// è¿™é‡Œæ‹¿åˆ°çš„æ˜¯åŸæ¥forwardInvocation:</span>
    <span class="n">Method</span> <span class="n">originalMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">AspectsForwardInvocationSelectorName</span><span class="p">));</span>
    <span class="c1">// æ‹¿åˆ° forwardInvocation:</span>
    <span class="n">Method</span> <span class="n">objectMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">NSObject</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">forwardInvocation</span><span class="o">:</span><span class="p">));</span>
    <span class="c1">// There is no class_removeMethod, so the best we can do is to retore the original implementation, or use a dummy.</span>
    <span class="n">IMP</span> <span class="n">originalImplementation</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">originalMethod</span> <span class="p">?:</span> <span class="n">objectMethod</span><span class="p">);</span>
    <span class="c1">// æ¢å›æ¥</span>
    <span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">forwardInvocation</span><span class="o">:</span><span class="p">),</span> <span class="n">originalImplementation</span><span class="p">,</span> <span class="s">"v@:@"</span><span class="p">);</span>

    <span class="n">AspectLog</span><span class="p">(</span><span class="s">@"Aspects: %@ has been restored."</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">klass</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_hookedGetClass</span><span class="p">(</span><span class="n">Class</span> <span class="n">class</span><span class="p">,</span> <span class="n">Class</span> <span class="n">statedClass</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">class</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">statedClass</span><span class="p">);</span>
    <span class="c1">// æ‹¿åˆ°class  methodã€‚</span>
	<span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">class</span><span class="p">));</span>
    <span class="c1">// åˆ›å»ºä¸€ä¸ªIMP</span>
	<span class="n">IMP</span> <span class="n">newIMP</span> <span class="o">=</span> <span class="n">imp_implementationWithBlock</span><span class="p">(</span><span class="o">^</span><span class="p">(</span><span class="n">id</span> <span class="n">self</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">statedClass</span><span class="p">;</span>
	<span class="p">});</span>
    <span class="c1">// æ›¿æ¢ @selector(class) çš„IMPä¸º newIMPã€‚å°±æ˜¯è¯´ã€‚è°ƒ classæ–¹æ³•æ—¶ã€‚è¿”å›çš„å®é™…æ˜¯statedClass</span>
	<span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">class</span><span class="p">),</span> <span class="n">newIMP</span><span class="p">,</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">method</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Swizzle Class In Place
</span>
<span class="c1">// æ··å†™ç±»</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_aspect_modifySwizzledClasses</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">swizzledClasses</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">swizzledClasses</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">pred</span><span class="p">;</span>
    <span class="c1">// å•ä¾‹</span>
    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pred</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="c1">// åˆå§‹åŒ–</span>
        <span class="n">swizzledClasses</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableSet</span> <span class="nf">new</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="k">@synchronized</span><span class="p">(</span><span class="n">swizzledClasses</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">block</span><span class="p">(</span><span class="n">swizzledClasses</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">Class</span> <span class="nf">aspect_swizzleClassInPlace</span><span class="p">(</span><span class="n">Class</span> <span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="c1">// ç±»å</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">className</span> <span class="o">=</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>

    <span class="n">_aspect_modifySwizzledClasses</span><span class="p">(</span><span class="o">^</span><span class="p">(</span><span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">swizzledClasses</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// è¿™ä¸ªswizzledClassesæ˜¯å¦åŒ…å«className</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">swizzledClasses</span> <span class="nf">containsObject</span><span class="p">:</span><span class="n">className</span><span class="p">])</span> <span class="p">{</span>
            <span class="c1">// å¦‚æœä¸åŒ…å«ã€‚aspect_swizzleForwardInvocation ï¼Œå¹¶åŠ å…¥</span>
            <span class="n">aspect_swizzleForwardInvocation</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
            <span class="p">[</span><span class="n">swizzledClasses</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">className</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">klass</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_undoSwizzleClassInPlace</span><span class="p">(</span><span class="n">Class</span> <span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">className</span> <span class="o">=</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>

    <span class="n">_aspect_modifySwizzledClasses</span><span class="p">(</span><span class="o">^</span><span class="p">(</span><span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">swizzledClasses</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">swizzledClasses</span> <span class="nf">containsObject</span><span class="p">:</span><span class="n">className</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">aspect_undoSwizzleForwardInvocation</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
            <span class="p">[</span><span class="n">swizzledClasses</span> <span class="nf">removeObject</span><span class="p">:</span><span class="n">className</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Aspect Invoke Point
</span>
<span class="c1">// This is a macro so we get a cleaner stack trace.</span>
<span class="c1">// è¿™æ˜¯ä¸€ä¸ªå®å®šä¹‰ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ›´æ¸…æ™°çš„ å †æ ˆè½¨è¿¹</span>
<span class="cp">#define aspect_invoke(aspects, info) \
for (AspectIdentifier *aspect in aspects) {\
    [aspect invokeWithInfo:info];\
    if (aspect.options &amp; AspectOptionAutomaticRemoval) { \
        aspectsToRemove = [aspectsToRemove?:@[] arrayByAddingObject:aspect]; \
    } \
}
</span>
<span class="c1">// This is the swizzled forwardInvocation: method.</span>
<span class="c1">// è¿™ä¸ªæ˜¯æ··å†™çš„forwardInvocation: method.</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ASPECTS_ARE_BEING_CALLED__</span><span class="p">(</span><span class="n">__unsafe_unretained</span> <span class="n">NSObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">,</span> <span class="n">NSInvocation</span> <span class="o">*</span><span class="n">invocation</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ä¸¤ä¸ªæ–­è¨€</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
    <span class="c1">// ä»invovationå¯ä»¥æ‹¿åˆ°å¾ˆå¤šä¸œè¥¿ æ¯”å¦‚ originalSelector</span>
    <span class="n">SEL</span> <span class="n">originalSelector</span> <span class="o">=</span> <span class="n">invocation</span><span class="p">.</span><span class="n">selector</span><span class="p">;</span>
    <span class="c1">// åŠ å‰ç¼€</span>
	<span class="n">SEL</span> <span class="n">aliasSelector</span> <span class="o">=</span> <span class="n">aspect_aliasForSelector</span><span class="p">(</span><span class="n">invocation</span><span class="p">.</span><span class="n">selector</span><span class="p">);</span>
    <span class="c1">// æ›¿æ¢</span>
    <span class="n">invocation</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">aliasSelector</span><span class="p">;</span>
    
    <span class="c1">// è·å– Instance çš„å®¹å™¨</span>
    <span class="n">AspectsContainer</span> <span class="o">*</span><span class="n">objectContainer</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">aliasSelector</span><span class="p">);</span>
    <span class="c1">// Class çš„å®¹å™¨</span>
    <span class="n">AspectsContainer</span> <span class="o">*</span><span class="n">classContainer</span> <span class="o">=</span> <span class="n">aspect_getContainerForClass</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">aliasSelector</span><span class="p">);</span>
    <span class="c1">// info</span>
    <span class="n">AspectInfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AspectInfo</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithInstance</span><span class="p">:</span><span class="n">self</span> <span class="nf">invocation</span><span class="p">:</span><span class="n">invocation</span><span class="p">];</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">aspectsToRemove</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="c1">// Before hooks.</span>
    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">classContainer</span><span class="p">.</span><span class="n">beforeAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">beforeAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

    <span class="c1">// Instead hooks.</span>
    <span class="n">BOOL</span> <span class="n">respondsToAlias</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">.</span><span class="n">count</span> <span class="o">||</span> <span class="n">classContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœæœ‰ä»»ä½• insteadAspects å°±ç›´æ¥æ›¿æ¢äº†</span>
        <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">classContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
        <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
        <span class="c1">// å¦åˆ™æ‰§è¡Œä¸‹é¢</span>
        
        <span class="n">Class</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">invocation</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
        
        <span class="c1">// éå† invocation.target åŠå…¶ superClass æ‰¾åˆ°å®ä¾‹å¯ä»¥å“åº” aliasSelector çš„ invoke</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">respondsToAlias</span> <span class="o">=</span> <span class="p">[</span><span class="n">klass</span> <span class="nf">instancesRespondToSelector</span><span class="p">:</span><span class="n">aliasSelector</span><span class="p">]))</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">invocation</span> <span class="nf">invoke</span><span class="p">];</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">respondsToAlias</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">klass</span> <span class="o">=</span> <span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">klass</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="c1">// After hooks.</span>
    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">classContainer</span><span class="p">.</span><span class="n">afterAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">afterAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

    <span class="c1">// If no hooks are installed, call original implementation (usually to throw an exception)</span>
    <span class="c1">// å¦‚æœæ²¡æœ‰hookï¼Œåˆ™æ‰§è¡ŒåŸå®ç°ï¼ˆé€šå¸¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">respondsToAlias</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">invocation</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">originalSelector</span><span class="p">;</span>
        <span class="n">SEL</span> <span class="n">originalForwardInvocationSEL</span> <span class="o">=</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">AspectsForwardInvocationSelectorName</span><span class="p">);</span>
        <span class="c1">// å¦‚æœå¯ä»¥å“åº” originalForwardInvocationSELï¼Œè¡¨ç¤ºä¹‹å‰æ˜¯ replace method è€Œé add method</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">self</span> <span class="nf">respondsToSelector</span><span class="p">:</span><span class="n">originalForwardInvocationSEL</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span><span class="p">(</span> <span class="o">*</span><span class="p">)(</span><span class="n">id</span><span class="p">,</span> <span class="n">SEL</span><span class="p">,</span> <span class="n">NSInvocation</span> <span class="o">*</span><span class="p">))</span><span class="n">objc_msgSend</span><span class="p">)(</span><span class="n">self</span><span class="p">,</span> <span class="n">originalForwardInvocationSEL</span><span class="p">,</span> <span class="n">invocation</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">self</span> <span class="nf">doesNotRecognizeSelector</span><span class="p">:</span><span class="n">invocation</span><span class="p">.</span><span class="n">selector</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ç§»é™¤ aspectsToRemove é˜Ÿåˆ—ä¸­çš„ AspectIdentifierï¼Œæ‰§è¡Œ remove</span>
    <span class="c1">// Remove any hooks that are queued for deregistration.</span>
    <span class="p">[</span><span class="n">aspectsToRemove</span> <span class="nf">makeObjectsPerformSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">remove</span><span class="p">)];</span>
<span class="p">}</span>
<span class="cp">#undef aspect_invoke
</span><span class="c1">// å»é™¤å®å®šä¹‰</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Aspect Container Management
</span>
<span class="c1">// Loads or creates the aspect container.</span>
<span class="c1">// åŠ è½½å¹¶åˆ›å»ºä¸€ä¸ªaspect container</span>
<span class="k">static</span> <span class="n">AspectsContainer</span> <span class="o">*</span><span class="nf">aspect_getContainerForObject</span><span class="p">(</span><span class="n">NSObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="c1">// è·å–åˆ«åselector</span>
    <span class="n">SEL</span> <span class="n">aliasSelector</span> <span class="o">=</span> <span class="n">aspect_aliasForSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="c1">// è·å–å…³è”å¯¹è±¡ï¼Œå¦‚æœä¸ºnilåˆ™setå…³è”å¯¹è±¡ã€‚</span>
    <span class="n">AspectsContainer</span> <span class="o">*</span><span class="n">aspectContainer</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">aliasSelector</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aspectContainer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">aspectContainer</span> <span class="o">=</span> <span class="p">[</span><span class="n">AspectsContainer</span> <span class="nf">new</span><span class="p">];</span>
        <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">aliasSelector</span><span class="p">,</span> <span class="n">aspectContainer</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_RETAIN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">aspectContainer</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ä¼ å…¥selector å’Œclass</span>
<span class="k">static</span> <span class="n">AspectsContainer</span> <span class="o">*</span><span class="nf">aspect_getContainerForClass</span><span class="p">(</span><span class="n">Class</span> <span class="n">klass</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ–­è¨€</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
    <span class="c1">// å®šä¹‰ä¸€ä¸ª</span>
    <span class="n">AspectsContainer</span> <span class="o">*</span><span class="n">classContainer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="c1">// éå†æ‰¾classContainer</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="n">classContainer</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">classContainer</span><span class="p">.</span><span class="n">hasAspects</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span><span class="k">while</span> <span class="p">((</span><span class="n">klass</span> <span class="o">=</span> <span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">klass</span><span class="p">)));</span>

    <span class="k">return</span> <span class="n">classContainer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_destroyContainerForObject</span><span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span> <span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="n">SEL</span> <span class="n">aliasSelector</span> <span class="o">=</span> <span class="n">aspect_aliasForSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">aliasSelector</span><span class="p">,</span> <span class="nb">nil</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_RETAIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - Selector Blacklist Checking
</span>
<span class="k">static</span> <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="nf">aspect_getSwizzledClassesDict</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// å•ä¾‹ï¼Œåˆå§‹åŒ–</span>
    <span class="k">static</span> <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">swizzledClassesDict</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">pred</span><span class="p">;</span>
    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pred</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">swizzledClassesDict</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableDictionary</span> <span class="nf">new</span><span class="p">];</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">swizzledClassesDict</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ£€æŸ¥å…è®¸</span>
<span class="k">static</span> <span class="n">BOOL</span> <span class="nf">aspect_isSelectorAllowedAndTrack</span><span class="p">(</span><span class="n">NSObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">,</span> <span class="n">AspectOptions</span> <span class="n">options</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// é»‘åå•</span>
    <span class="k">static</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">disallowedSelectorList</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">pred</span><span class="p">;</span>
    <span class="c1">// ä¸€ä¸ªå•ä¾‹</span>
    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pred</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="c1">// åˆå§‹åŒ–ã€‚</span>
        <span class="n">disallowedSelectorList</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nf">setWithObjects</span><span class="p">:</span><span class="s">@"retain"</span><span class="p">,</span> <span class="s">@"release"</span><span class="p">,</span> <span class="s">@"autorelease"</span><span class="p">,</span> <span class="s">@"forwardInvocation:"</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
    <span class="p">});</span>

    <span class="c1">// Check against the blacklist.</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">selectorName</span> <span class="o">=</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">disallowedSelectorList</span> <span class="nf">containsObject</span><span class="p">:</span><span class="n">selectorName</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœåœ¨é»‘åå•é‡Œ</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">errorDescription</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"Selector %@ is blacklisted."</span><span class="p">,</span> <span class="n">selectorName</span><span class="p">];</span>
        <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorSelectorBlacklisted</span><span class="p">,</span> <span class="n">errorDescription</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Additional checks.</span>
    <span class="c1">// ä¿è¯æ˜¯012ä¸­çš„ä¸€ä¸ªã€‚</span>
    <span class="n">AspectOptions</span> <span class="n">position</span> <span class="o">=</span> <span class="n">options</span><span class="o">&amp;</span><span class="n">AspectPositionFilter</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">selectorName</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="s">@"dealloc"</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">position</span> <span class="o">!=</span> <span class="n">AspectPositionBefore</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœæ˜¯dealloc &amp;&amp; ä¸æ˜¯ before</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">errorDesc</span> <span class="o">=</span> <span class="s">@"AspectPositionBefore is the only valid position when hooking dealloc."</span><span class="p">;</span>
        <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorSelectorDeallocPosition</span><span class="p">,</span> <span class="n">errorDesc</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span> <span class="nf">respondsToSelector</span><span class="p">:</span><span class="n">selector</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">class</span> <span class="nf">instancesRespondToSelector</span><span class="p">:</span><span class="n">selector</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœæ²¡æœ‰è¿™ä¸ªselector</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">errorDesc</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"Unable to find selector -[%@ %@]."</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">class</span><span class="p">),</span> <span class="n">selectorName</span><span class="p">];</span>
        <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorDoesNotRespondToSelector</span><span class="p">,</span> <span class="n">errorDesc</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Search for the current class and the class hierarchy IF we are modifying a class object</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">class_isMetaClass</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">)))</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœæ˜¯å…ƒç±»</span>
        <span class="n">Class</span> <span class="n">klass</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">class</span><span class="p">];</span>
        <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">swizzledClassesDict</span> <span class="o">=</span> <span class="n">aspect_getSwizzledClassesDict</span><span class="p">();</span>
        <span class="n">Class</span> <span class="n">currentClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">class</span><span class="p">];</span>
        
        <span class="c1">// è¿™é‡Œå…ˆæ‰¾çœ‹èƒ½ä¸èƒ½ä»swizzledClassesDictä¸­æ‰¾åˆ°è¿™ä¸ªclasså¯¹åº”çš„trackerã€‚</span>
        <span class="c1">// åˆ†ä¸ºä¸¤ç§æƒ…å†µ</span>
        <span class="cm">/*
         1.ä¸ºnilã€‚åˆ™åˆå§‹åŒ–ã€‚å¹¶èµ‹å€¼ã€‚swizzledClassesDictä¸­ã€‚keyæ˜¯class
         2.ä¸ä¸ºnilã€‚åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚è¿”å›NOã€‚
         */</span>

        <span class="n">AspectTracker</span> <span class="o">*</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">swizzledClassesDict</span><span class="p">[</span><span class="nf">currentClass</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">tracker</span> <span class="nf">subclassHasHookedSelectorName</span><span class="p">:</span><span class="n">selectorName</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">NSSet</span> <span class="o">*</span><span class="n">subclassTracker</span> <span class="o">=</span> <span class="p">[</span><span class="n">tracker</span> <span class="nf">subclassTrackersHookingSelectorName</span><span class="p">:</span><span class="n">selectorName</span><span class="p">];</span>
            <span class="n">NSSet</span> <span class="o">*</span><span class="n">subclassNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">subclassTracker</span> <span class="nf">valueForKey</span><span class="p">:</span><span class="s">@"trackedClassName"</span><span class="p">];</span>
            <span class="n">NSString</span> <span class="o">*</span><span class="n">errorDescription</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"Error: %@ already hooked subclasses: %@. A method can only be hooked once per class hierarchy."</span><span class="p">,</span> <span class="n">selectorName</span><span class="p">,</span> <span class="n">subclassNames</span><span class="p">];</span>
            <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorSelectorAlreadyHookedInClassHierarchy</span><span class="p">,</span> <span class="n">errorDescription</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">do</span> <span class="p">{</span>
            <span class="n">tracker</span> <span class="o">=</span> <span class="n">swizzledClassesDict</span><span class="p">[</span><span class="nf">currentClass</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">([</span><span class="n">tracker</span><span class="p">.</span><span class="n">selectorNames</span> <span class="nf">containsObject</span><span class="p">:</span><span class="n">selectorName</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">klass</span> <span class="o">==</span> <span class="n">currentClass</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Already modified and topmost!</span>
                    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">NSString</span> <span class="o">*</span><span class="n">errorDescription</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"Error: %@ already hooked in %@. A method can only be hooked once per class hierarchy."</span><span class="p">,</span> <span class="n">selectorName</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">currentClass</span><span class="p">)];</span>
                <span class="n">AspectError</span><span class="p">(</span><span class="n">AspectErrorSelectorAlreadyHookedInClassHierarchy</span><span class="p">,</span> <span class="n">errorDescription</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">currentClass</span> <span class="o">=</span> <span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">currentClass</span><span class="p">)));</span>

        <span class="c1">// Add the selector as being modified.</span>
        <span class="n">currentClass</span> <span class="o">=</span> <span class="n">klass</span><span class="p">;</span>
        <span class="n">AspectTracker</span> <span class="o">*</span><span class="n">subclassTracker</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">tracker</span> <span class="o">=</span> <span class="n">swizzledClassesDict</span><span class="p">[</span><span class="nf">currentClass</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tracker</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tracker</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AspectTracker</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithTrackedClass</span><span class="p">:</span><span class="n">currentClass</span><span class="p">];</span>
                <span class="n">swizzledClassesDict</span><span class="p">[(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">NSCopying</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">currentClass</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracker</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">subclassTracker</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">tracker</span> <span class="nf">addSubclassTracker</span><span class="p">:</span><span class="n">subclassTracker</span> <span class="nf">hookingSelectorName</span><span class="p">:</span><span class="n">selectorName</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">tracker</span><span class="p">.</span><span class="n">selectorNames</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">selectorName</span><span class="p">];</span>
            <span class="p">}</span>

            <span class="c1">// All superclasses get marked as having a subclass that is modified.</span>
            <span class="n">subclassTracker</span> <span class="o">=</span> <span class="n">tracker</span><span class="p">;</span>
        <span class="p">}</span><span class="k">while</span> <span class="p">((</span><span class="n">currentClass</span> <span class="o">=</span> <span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">currentClass</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
	<span class="p">}</span>

    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_deregisterTrackedSelector</span><span class="p">(</span><span class="n">id</span> <span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">class_isMetaClass</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">swizzledClassesDict</span> <span class="o">=</span> <span class="n">aspect_getSwizzledClassesDict</span><span class="p">();</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">selectorName</span> <span class="o">=</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="n">Class</span> <span class="n">currentClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">class</span><span class="p">];</span>
    <span class="n">AspectTracker</span> <span class="o">*</span><span class="n">subclassTracker</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="n">AspectTracker</span> <span class="o">*</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">swizzledClassesDict</span><span class="p">[</span><span class="nf">currentClass</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subclassTracker</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">tracker</span> <span class="nf">removeSubclassTracker</span><span class="p">:</span><span class="n">subclassTracker</span> <span class="nf">hookingSelectorName</span><span class="p">:</span><span class="n">selectorName</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">tracker</span><span class="p">.</span><span class="n">selectorNames</span> <span class="nf">removeObject</span><span class="p">:</span><span class="n">selectorName</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tracker</span><span class="p">.</span><span class="n">selectorNames</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tracker</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">swizzledClassesDict</span> <span class="nf">removeObjectForKey</span><span class="p">:</span><span class="n">currentClass</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">subclassTracker</span> <span class="o">=</span> <span class="n">tracker</span><span class="p">;</span>
    <span class="p">}</span><span class="k">while</span> <span class="p">((</span><span class="n">currentClass</span> <span class="o">=</span> <span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">currentClass</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">AspectTracker</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithTrackedClass</span><span class="p">:(</span><span class="n">Class</span><span class="p">)</span><span class="nv">trackedClass</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">_trackedClass</span> <span class="o">=</span> <span class="n">trackedClass</span><span class="p">;</span>
        <span class="n">_selectorNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableSet</span> <span class="nf">new</span><span class="p">];</span>
        <span class="n">_selectorNamesToSubclassTrackers</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableDictionary</span> <span class="nf">new</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">subclassHasHookedSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">[</span><span class="nf">selectorName</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addSubclassTracker</span><span class="p">:(</span><span class="n">AspectTracker</span> <span class="o">*</span><span class="p">)</span><span class="nv">subclassTracker</span> <span class="nf">hookingSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span> <span class="p">{</span>
    <span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">trackerSet</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">[</span><span class="nf">selectorName</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trackerSet</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">trackerSet</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableSet</span> <span class="nf">new</span><span class="p">];</span>
        <span class="n">self</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">[</span><span class="nf">selectorName</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackerSet</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">trackerSet</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">subclassTracker</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeSubclassTracker</span><span class="p">:(</span><span class="n">AspectTracker</span> <span class="o">*</span><span class="p">)</span><span class="nv">subclassTracker</span> <span class="nf">hookingSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span> <span class="p">{</span>
    <span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">trackerSet</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">[</span><span class="nf">selectorName</span><span class="p">];</span>
    <span class="p">[</span><span class="n">trackerSet</span> <span class="nf">removeObject</span><span class="p">:</span><span class="n">subclassTracker</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">trackerSet</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span> <span class="nf">removeObjectForKey</span><span class="p">:</span><span class="n">selectorName</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="p">)</span><span class="nf">subclassTrackersHookingSelectorName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">selectorName</span> <span class="p">{</span>
    <span class="n">NSMutableSet</span> <span class="o">*</span><span class="n">hookingSubclassTrackers</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableSet</span> <span class="nf">new</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">AspectTracker</span> <span class="o">*</span><span class="n">tracker</span> <span class="k">in</span> <span class="n">self</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">[</span><span class="nf">selectorName</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">tracker</span><span class="p">.</span><span class="n">selectorNames</span> <span class="nf">containsObject</span><span class="p">:</span><span class="n">selectorName</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">hookingSubclassTrackers</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">tracker</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="p">[</span><span class="n">hookingSubclassTrackers</span> <span class="nf">unionSet</span><span class="p">:[</span><span class="n">tracker</span> <span class="nf">subclassTrackersHookingSelectorName</span><span class="p">:</span><span class="n">selectorName</span><span class="p">]];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">hookingSubclassTrackers</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">trackedClassName</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">trackedClass</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">description</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"&lt;%@: %@, trackedClass: %@, selectorNames:%@, subclass selector names: %@&gt;"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">trackedClass</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">selectorNames</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">selectorNamesToSubclassTrackers</span><span class="p">.</span><span class="n">allKeys</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - NSInvocation (Aspects)
</span>
<span class="k">@implementation</span> <span class="nc">NSInvocation</span> <span class="p">(</span><span class="nl">Aspects</span><span class="p">)</span>

<span class="c1">// Thanks to the ReactiveCocoa team for providing a generic solution for this.</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">aspect_argumentAtIndex</span><span class="p">:(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nv">index</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argType</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">methodSignature</span> <span class="nf">getArgumentTypeAtIndex</span><span class="p">:</span><span class="n">index</span><span class="p">];</span>
	<span class="c1">// Skip const type qualifier.</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">_C_CONST</span><span class="p">)</span> <span class="n">argType</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#define WRAP_AND_RETURN(type) do { type val = 0; [self getArgument:&amp;val atIndex:(NSInteger)index]; return @(val); } while (0)
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="n">Class</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__autoreleasing</span> <span class="n">id</span> <span class="n">returnObj</span><span class="p">;</span>
		<span class="p">[</span><span class="n">self</span> <span class="nf">getArgument</span><span class="p">:</span><span class="o">&amp;</span><span class="n">returnObj</span> <span class="nf">atIndex</span><span class="p">:(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">index</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">returnObj</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="n">SEL</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SEL</span> <span class="n">selector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">getArgument</span><span class="p">:</span><span class="o">&amp;</span><span class="n">selector</span> <span class="nf">atIndex</span><span class="p">:(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">index</span><span class="p">];</span>
        <span class="k">return</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="n">Class</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__autoreleasing</span> <span class="n">Class</span> <span class="n">theClass</span> <span class="o">=</span> <span class="n">Nil</span><span class="p">;</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">getArgument</span><span class="p">:</span><span class="o">&amp;</span><span class="n">theClass</span> <span class="nf">atIndex</span><span class="p">:(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">index</span><span class="p">];</span>
        <span class="k">return</span> <span class="n">theClass</span><span class="p">;</span>
        <span class="c1">// Using this list will box the number with the appropriate constructor, instead of the generic NSValue.</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">char</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">short</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">float</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="kt">double</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="n">BOOL</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="n">BOOL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="n">bool</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="n">BOOL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRAP_AND_RETURN</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">void</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__unsafe_unretained</span> <span class="n">id</span> <span class="n">block</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
		<span class="p">[</span><span class="n">self</span> <span class="nf">getArgument</span><span class="p">:</span><span class="o">&amp;</span><span class="n">block</span> <span class="nf">atIndex</span><span class="p">:(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">index</span><span class="p">];</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">block</span> <span class="nf">copy</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NSUInteger</span> <span class="n">valueSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">NSGetSizeAndAlignment</span><span class="p">(</span><span class="n">argType</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valueSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueBytes</span><span class="p">[</span><span class="nf">valueSize</span><span class="p">];</span>
		<span class="p">[</span><span class="n">self</span> <span class="nf">getArgument</span><span class="p">:</span><span class="n">valueBytes</span> <span class="nf">atIndex</span><span class="p">:(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">index</span><span class="p">];</span>

		<span class="k">return</span> <span class="p">[</span><span class="n">NSValue</span> <span class="nf">valueWithBytes</span><span class="p">:</span><span class="n">valueBytes</span> <span class="nf">objCType</span><span class="p">:</span><span class="n">argType</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
<span class="cp">#undef WRAP_AND_RETURN
</span><span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">aspects_arguments</span> <span class="p">{</span>
	<span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">argumentsArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">NSUInteger</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">methodSignature</span><span class="p">.</span><span class="n">numberOfArguments</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">argumentsArray</span> <span class="nf">addObject</span><span class="p">:[</span><span class="n">self</span> <span class="nf">aspect_argumentAtIndex</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="p">?:</span> <span class="n">NSNull</span><span class="p">.</span><span class="n">null</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">[</span><span class="n">argumentsArray</span> <span class="nf">copy</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - AspectIdentifier
</span>
<span class="k">@implementation</span> <span class="nc">AspectIdentifier</span>

<span class="c1">// å®ä¾‹åŒ–</span>
<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">identifierWithSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">selector</span> <span class="nf">object</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">object</span> <span class="nf">options</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span> <span class="nf">block</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">block</span> <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
    <span class="c1">// æ ¹æ®blockç”Ÿæˆæ–¹æ³•ç­¾å</span>
    <span class="n">NSMethodSignature</span> <span class="o">*</span><span class="n">blockSignature</span> <span class="o">=</span> <span class="n">aspect_blockMethodSignature</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span> <span class="c1">// TODO: check signature compatibility, etc.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aspect_isCompatibleBlockSignature</span><span class="p">(</span><span class="n">blockSignature</span><span class="p">,</span> <span class="n">object</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ä¸‹é¢å¼€å§‹åˆå§‹åŒ–</span>
    <span class="n">AspectIdentifier</span> <span class="o">*</span><span class="n">identifier</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">blockSignature</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="p">[</span><span class="n">AspectIdentifier</span> <span class="nf">new</span><span class="p">];</span>
        <span class="n">identifier</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span><span class="p">;</span>
        <span class="n">identifier</span><span class="p">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
        <span class="n">identifier</span><span class="p">.</span><span class="n">blockSignature</span> <span class="o">=</span> <span class="n">blockSignature</span><span class="p">;</span>
        <span class="n">identifier</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
        <span class="n">identifier</span><span class="p">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">object</span><span class="p">;</span> <span class="c1">// weak</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">identifier</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">invokeWithInfo</span><span class="p">:(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">AspectInfo</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">info</span> <span class="p">{</span>
    <span class="n">NSInvocation</span> <span class="o">*</span><span class="n">blockInvocation</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSInvocation</span> <span class="nf">invocationWithMethodSignature</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">blockSignature</span><span class="p">];</span>
    <span class="n">NSInvocation</span> <span class="o">*</span><span class="n">originalInvocation</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">originalInvocation</span><span class="p">;</span>
    <span class="n">NSUInteger</span> <span class="n">numberOfArguments</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">blockSignature</span><span class="p">.</span><span class="n">numberOfArguments</span><span class="p">;</span>

    <span class="c1">// Be extra paranoid. We already check that on hook registration.</span>
    <span class="c1">// è¿™é‡Œå†æ£€æŸ¥ä¸€é</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numberOfArguments</span> <span class="o">&gt;</span> <span class="n">originalInvocation</span><span class="p">.</span><span class="n">methodSignature</span><span class="p">.</span><span class="n">numberOfArguments</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">AspectLogError</span><span class="p">(</span><span class="s">@"Block has too many arguments. Not calling %@"</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// The `self` of the block will be the AspectInfo. Optional.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numberOfArguments</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">blockInvocation</span> <span class="nf">setArgument</span><span class="p">:</span><span class="o">&amp;</span><span class="n">info</span> <span class="nf">atIndex</span><span class="p">:</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    
	<span class="kt">void</span> <span class="o">*</span><span class="n">argBuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">NSUInteger</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">numberOfArguments</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="p">[</span><span class="n">originalInvocation</span><span class="p">.</span><span class="n">methodSignature</span> <span class="nf">getArgumentTypeAtIndex</span><span class="p">:</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">NSUInteger</span> <span class="n">argSize</span><span class="p">;</span>
		<span class="n">NSGetSizeAndAlignment</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">argBuf</span> <span class="o">=</span> <span class="n">reallocf</span><span class="p">(</span><span class="n">argBuf</span><span class="p">,</span> <span class="n">argSize</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">AspectLogError</span><span class="p">(</span><span class="s">@"Failed to allocate memory for block invocation."</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
		<span class="p">}</span>
        
		<span class="p">[</span><span class="n">originalInvocation</span> <span class="nf">getArgument</span><span class="p">:</span><span class="n">argBuf</span> <span class="nf">atIndex</span><span class="p">:</span><span class="n">idx</span><span class="p">];</span>
		<span class="p">[</span><span class="n">blockInvocation</span> <span class="nf">setArgument</span><span class="p">:</span><span class="n">argBuf</span> <span class="nf">atIndex</span><span class="p">:</span><span class="n">idx</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="p">[</span><span class="n">blockInvocation</span> <span class="nf">invokeWithTarget</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">block</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">argBuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">argBuf</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æè¿°</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">description</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"&lt;%@: %p, SEL:%@ object:%@ options:%tu block:%@ (#%tu args)&gt;"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">selector</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">object</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">block</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">blockSignature</span><span class="p">.</span><span class="n">numberOfArguments</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// è¿™é‡Œæ˜¯ä»£ç†æ–¹æ³•ã€‚</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">remove</span> <span class="p">{</span>
    <span class="c1">// å®é™…è°ƒç”¨äº† aspect_remove</span>
    <span class="k">return</span> <span class="n">aspect_remove</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - AspectsContainer
</span>
<span class="k">@implementation</span> <span class="nc">AspectsContainer</span>

<span class="c1">// æ˜¯å¦æœ‰aspect</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">hasAspects</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">beforeAspects</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">self</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">self</span><span class="p">.</span><span class="n">afterAspects</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// åŠ å…¥aspect</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addAspect</span><span class="p">:(</span><span class="n">AspectIdentifier</span> <span class="o">*</span><span class="p">)</span><span class="nv">aspect</span> <span class="nf">withOptions</span><span class="p">:(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span> <span class="p">{</span>
    <span class="n">NSParameterAssert</span><span class="p">(</span><span class="n">aspect</span><span class="p">);</span>
    <span class="n">NSUInteger</span> <span class="n">position</span> <span class="o">=</span> <span class="n">options</span><span class="o">&amp;</span><span class="n">AspectPositionFilter</span><span class="p">;</span>
    <span class="c1">// è¿™é‡Œåšä¸€ä¸ªåˆ¤æ–­ï¼ŒåŠ å…¥ä¸åŒçš„list</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">AspectPositionBefore</span><span class="p">:</span>  <span class="n">self</span><span class="p">.</span><span class="n">beforeAspects</span>  <span class="o">=</span> <span class="p">[(</span><span class="n">self</span><span class="p">.</span><span class="n">beforeAspects</span> <span class="p">?:@[])</span> <span class="nf">arrayByAddingObject</span><span class="p">:</span><span class="n">aspect</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">AspectPositionInstead</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">insteadAspects</span> <span class="o">=</span> <span class="p">[(</span><span class="n">self</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">?:@[])</span> <span class="nf">arrayByAddingObject</span><span class="p">:</span><span class="n">aspect</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">AspectPositionAfter</span><span class="p">:</span>   <span class="n">self</span><span class="p">.</span><span class="n">afterAspects</span>   <span class="o">=</span> <span class="p">[(</span><span class="n">self</span><span class="p">.</span><span class="n">afterAspects</span>  <span class="p">?:@[])</span> <span class="nf">arrayByAddingObject</span><span class="p">:</span><span class="n">aspect</span><span class="p">];</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ç§»é™¤aspect</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">removeAspect</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">aspect</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">aspectArrayName</span> <span class="k">in</span> <span class="p">@[</span><span class="n">NSStringFromSelector</span><span class="p">(</span><span class="k">@selector</span><span class="p">(</span><span class="n">beforeAspects</span><span class="p">)),</span>
                                        <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="k">@selector</span><span class="p">(</span><span class="n">insteadAspects</span><span class="p">)),</span>
                                        <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="k">@selector</span><span class="p">(</span><span class="n">afterAspects</span><span class="p">))])</span> <span class="p">{</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">valueForKey</span><span class="p">:</span><span class="n">aspectArrayName</span><span class="p">];</span>
        <span class="n">NSUInteger</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span> <span class="nf">indexOfObjectIdenticalTo</span><span class="p">:</span><span class="n">aspect</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">array</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">NSNotFound</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">newArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">arrayWithArray</span><span class="p">:</span><span class="n">array</span><span class="p">];</span>
            <span class="p">[</span><span class="n">newArray</span> <span class="nf">removeObjectAtIndex</span><span class="p">:</span><span class="n">index</span><span class="p">];</span>
            <span class="p">[</span><span class="n">self</span> <span class="nf">setValue</span><span class="p">:</span><span class="n">newArray</span> <span class="nf">forKey</span><span class="p">:</span><span class="n">aspectArrayName</span><span class="p">];</span>
            <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æè¿°</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">description</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"&lt;%@: %p, before:%@, instead:%@, after:%@&gt;"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">beforeAspects</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">afterAspects</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="c1">///////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="cp">#pragma mark - AspectInfo
</span>
<span class="k">@implementation</span> <span class="nc">AspectInfo</span>

<span class="k">@synthesize</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">_arguments</span><span class="p">;</span>

<span class="c1">// åˆå§‹åŒ–</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithInstance</span><span class="p">:(</span><span class="n">__unsafe_unretained</span> <span class="n">id</span><span class="p">)</span><span class="nv">instance</span> <span class="nf">invocation</span><span class="p">:(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span> <span class="p">{</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// å®ä¾‹</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>
        <span class="c1">// è°ƒç”¨</span>
        <span class="n">_originalInvocation</span> <span class="o">=</span> <span class="n">invocation</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ‡’åŠ è½½</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">arguments</span> <span class="p">{</span>
    <span class="c1">// Lazily evaluate arguments, boxing is expensive.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_arguments</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_arguments</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">originalInvocation</span><span class="p">.</span><span class="n">aspects_arguments</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_arguments</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>

</code></pre></div></div>

:ET